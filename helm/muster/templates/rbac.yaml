{{/*
RBAC Configuration for muster

Muster needs access to its own CRDs (MCPServer, ServiceClass, Workflow)
plus optional Kubernetes API access based on the RBAC profile.

RBAC Profiles:
  - minimal:  Only muster CRDs (MCPServer, ServiceClass, Workflow)
  - readonly: Read-only access to common K8s resources + muster CRDs
  - standard: Read + limited write for full muster functionality
*/}}

{{- define "muster.rbac.musterCRDRules" -}}
# Muster CRDs - always required
- apiGroups: ["muster.giantswarm.io"]
  resources: ["mcpservers", "serviceclasses", "workflows"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

# CRD discovery
- apiGroups: ["apiextensions.k8s.io"]
  resources: ["customresourcedefinitions"]
  verbs: ["get", "list", "watch"]
{{- end }}

{{- define "muster.rbac.minimalRules" -}}
# Minimal profile: Only muster CRDs
{{- include "muster.rbac.musterCRDRules" . }}
{{- end }}

{{- define "muster.rbac.readonlyRules" -}}
# Readonly profile: Read-only K8s resources + muster CRDs
{{- include "muster.rbac.musterCRDRules" . }}

# Core resources (read-only)
- apiGroups: [""]
  resources: ["pods", "services", "endpoints", "nodes", "namespaces", "configmaps", "events"]
  verbs: ["get", "list", "watch"]

# Apps resources (read-only)
- apiGroups: ["apps"]
  resources: ["deployments", "replicasets", "statefulsets", "daemonsets"]
  verbs: ["get", "list", "watch"]

# Networking resources (read-only)
- apiGroups: ["networking.k8s.io"]
  resources: ["ingresses", "networkpolicies"]
  verbs: ["get", "list", "watch"]

# Batch resources (read-only)
- apiGroups: ["batch"]
  resources: ["jobs", "cronjobs"]
  verbs: ["get", "list", "watch"]
{{- end }}

{{- define "muster.rbac.standardRules" -}}
# Standard profile: Read + write for full muster functionality
{{- include "muster.rbac.musterCRDRules" . }}

# Core resources
- apiGroups: [""]
  resources: ["pods", "services", "endpoints", "nodes", "namespaces", "configmaps", "secrets", "events"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

# Apps resources
- apiGroups: ["apps"]
  resources: ["deployments", "replicasets", "statefulsets", "daemonsets"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

# Networking resources
- apiGroups: ["networking.k8s.io"]
  resources: ["ingresses", "networkpolicies"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

# Batch resources
- apiGroups: ["batch"]
  resources: ["jobs", "cronjobs"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

# Storage resources (read-only)
- apiGroups: ["storage.k8s.io"]
  resources: ["storageclasses"]
  verbs: ["get", "list", "watch"]
{{- end }}

{{- if and .Values.serviceAccount.create .Values.rbac.create -}}
{{- $profile := .Values.rbac.profile | default "standard" -}}
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "muster.fullname" . }}
  labels:
    {{- include "muster.labels" . | nindent 4 }}
  annotations:
    muster.giantswarm.io/rbac-profile: {{ $profile | quote }}
{{- if .Values.rbac.custom.enabled }}
# Custom RBAC rules
rules:
{{ toYaml .Values.rbac.custom.rules | indent 2 }}
{{- else if eq $profile "minimal" }}
rules:
{{- include "muster.rbac.minimalRules" . | nindent 2 }}
{{- else if eq $profile "readonly" }}
rules:
{{- include "muster.rbac.readonlyRules" . | nindent 2 }}
{{- else if eq $profile "standard" }}
rules:
{{- include "muster.rbac.standardRules" . | nindent 2 }}
{{- else }}
{{- fail (printf "Unknown RBAC profile: %s. Valid profiles are: minimal, readonly, standard" $profile) }}
{{- end }}

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ include "muster.fullname" . }}
  labels:
    {{- include "muster.labels" . | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: {{ include "muster.fullname" . }}
subjects:
  - kind: ServiceAccount
    name: {{ include "muster.serviceAccountName" . }}
    namespace: {{ .Release.Namespace }}
{{- end }}

