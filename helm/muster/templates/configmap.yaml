apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "muster.fullname" . }}-config
  labels:
    {{- include "muster.labels" . | nindent 4 }}
data:
  config.yaml: |
    aggregator:
      host: "0.0.0.0"
      port: {{ .Values.muster.aggregator.port }}
      transport: {{ .Values.muster.aggregator.transport | quote }}
      oauth:
        {{- if .Values.muster.oauth.mcpClient.enabled }}
        mcpClient:
          enabled: true
          publicUrl: {{ .Values.muster.oauth.mcpClient.publicUrl | quote }}
          {{- if .Values.muster.oauth.mcpClient.clientId }}
          clientId: {{ .Values.muster.oauth.mcpClient.clientId | quote }}
          {{- end }}
          callbackPath: {{ .Values.muster.oauth.mcpClient.callbackPath | default "/oauth/proxy/callback" | quote }}
          cimd:
            path: {{ .Values.muster.oauth.mcpClient.cimd.path | default "/.well-known/oauth-client.json" | quote }}
            {{- if .Values.muster.oauth.mcpClient.cimd.scopes }}
            scopes: {{ .Values.muster.oauth.mcpClient.cimd.scopes | quote }}
            {{- end }}
        {{- end }}
        {{- if .Values.muster.oauth.server.enabled }}
        {{- $secretsPath := "/etc/muster/secrets" }}
        server:
          enabled: true
          baseUrl: {{ .Values.muster.oauth.server.baseUrl | quote }}
          provider: {{ .Values.muster.oauth.server.provider | default "dex" | quote }}
          {{- /* Secret file paths - secrets are mounted from Kubernetes Secret */}}
          {{- /* Only reference registration token file if it will exist in the secret */}}
          {{- if or .Values.muster.oauth.server.existingSecret .Values.muster.oauth.server.registrationToken }}
          registrationTokenFile: {{ printf "%s/registration-token" $secretsPath | quote }}
          {{- end }}
          {{- if .Values.muster.oauth.server.encryptionKey }}
          encryptionKeyFile: {{ printf "%s/oauth-encryption-key" $secretsPath | quote }}
          {{- end }}
          {{- if eq (.Values.muster.oauth.server.provider | default "dex") "dex" }}
          dex:
            issuerUrl: {{ .Values.muster.oauth.server.dex.issuerUrl | quote }}
            clientId: {{ .Values.muster.oauth.server.dex.clientId | quote }}
            clientSecretFile: {{ printf "%s/dex-client-secret" $secretsPath | quote }}
            {{- if .Values.muster.oauth.server.dex.connectorId }}
            connectorId: {{ .Values.muster.oauth.server.dex.connectorId | quote }}
            {{- end }}
          {{- else if eq .Values.muster.oauth.server.provider "google" }}
          google:
            clientId: {{ .Values.muster.oauth.server.google.clientId | quote }}
            clientSecretFile: {{ printf "%s/google-client-secret" $secretsPath | quote }}
          {{- end }}
          storage:
            type: {{ .Values.muster.oauth.server.storage.type | default "memory" | quote }}
            {{- if eq .Values.muster.oauth.server.storage.type "valkey" }}
            valkey:
              url: {{ .Values.muster.oauth.server.storage.valkey.url | quote }}
              {{- /* Only reference password file if Valkey password is configured */}}
              {{- if or .Values.muster.oauth.server.storage.valkey.existingSecret .Values.muster.oauth.server.existingSecret .Values.muster.oauth.server.storage.valkey.password }}
              passwordFile: {{ printf "%s/valkey-password" $secretsPath | quote }}
              {{- end }}
              {{- if .Values.muster.oauth.server.storage.valkey.keyPrefix }}
              keyPrefix: {{ .Values.muster.oauth.server.storage.valkey.keyPrefix | quote }}
              {{- end }}
              {{- if .Values.muster.oauth.server.storage.valkey.db }}
              db: {{ .Values.muster.oauth.server.storage.valkey.db }}
              {{- end }}
              {{- if .Values.muster.oauth.server.storage.valkey.tls.enabled }}
              tlsEnabled: true
              {{- end }}
            {{- end }}
          {{- if .Values.muster.oauth.server.allowLocalhostRedirectURIs }}
          allowLocalhostRedirectURIs: true
          {{- end }}
        {{- end }}
    namespace: {{ include "muster.namespace" . | quote }}
    kubernetes: true
    {{- if .Values.muster.events }}
    events: true
    {{- end }}
