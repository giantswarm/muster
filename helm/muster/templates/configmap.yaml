apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "muster.fullname" . }}-config
  labels:
    {{- include "muster.labels" . | nindent 4 }}
data:
  config.yaml: |
    aggregator:
      host: "0.0.0.0"
      port: {{ .Values.muster.aggregator.port }}
      transport: {{ .Values.muster.aggregator.transport | quote }}
      {{- if .Values.muster.oauthServer.enabled }}
      {{- $secretsPath := "/etc/muster/secrets" }}
      oauthServer:
        enabled: true
        baseUrl: {{ .Values.muster.oauthServer.baseUrl | quote }}
        provider: {{ .Values.muster.oauthServer.provider | default "dex" | quote }}
        {{- /* Secret file paths - secrets are mounted from Kubernetes Secret */}}
        {{- /* Only reference registration token file if it will exist in the secret */}}
        {{- if or .Values.muster.oauthServer.existingSecret .Values.muster.oauthServer.registrationToken }}
        registrationTokenFile: {{ printf "%s/registration-token" $secretsPath | quote }}
        {{- end }}
        {{- if .Values.muster.oauthServer.encryptionKey }}
        encryptionKeyFile: {{ printf "%s/oauth-encryption-key" $secretsPath | quote }}
        {{- end }}
        {{- if eq (.Values.muster.oauthServer.provider | default "dex") "dex" }}
        dex:
          issuerUrl: {{ .Values.muster.oauthServer.dex.issuerUrl | quote }}
          clientId: {{ .Values.muster.oauthServer.dex.clientId | quote }}
          clientSecretFile: {{ printf "%s/dex-client-secret" $secretsPath | quote }}
          {{- if .Values.muster.oauthServer.dex.connectorId }}
          connectorId: {{ .Values.muster.oauthServer.dex.connectorId | quote }}
          {{- end }}
          {{- if .Values.muster.oauthServer.dex.kubernetesAuthenticatorClientId }}
          kubernetesAuthenticatorClientId: {{ .Values.muster.oauthServer.dex.kubernetesAuthenticatorClientId | quote }}
          {{- end }}
        {{- else if eq .Values.muster.oauthServer.provider "google" }}
        google:
          clientId: {{ .Values.muster.oauthServer.google.clientId | quote }}
          clientSecretFile: {{ printf "%s/google-client-secret" $secretsPath | quote }}
        {{- end }}
        storage:
          type: {{ .Values.muster.oauthServer.storage.type | default "memory" | quote }}
          {{- if eq .Values.muster.oauthServer.storage.type "valkey" }}
          valkey:
            url: {{ .Values.muster.oauthServer.storage.valkey.url | quote }}
            {{- /* Only reference password file if Valkey password is configured */}}
            {{- if or .Values.muster.oauthServer.storage.valkey.existingSecret .Values.muster.oauthServer.existingSecret .Values.muster.oauthServer.storage.valkey.password }}
            passwordFile: {{ printf "%s/valkey-password" $secretsPath | quote }}
            {{- end }}
            {{- if .Values.muster.oauthServer.storage.valkey.keyPrefix }}
            keyPrefix: {{ .Values.muster.oauthServer.storage.valkey.keyPrefix | quote }}
            {{- end }}
            {{- if .Values.muster.oauthServer.storage.valkey.db }}
            db: {{ .Values.muster.oauthServer.storage.valkey.db }}
            {{- end }}
            {{- if .Values.muster.oauthServer.storage.valkey.tls.enabled }}
            tlsEnabled: true
            {{- end }}
          {{- end }}
      {{- end }}
    namespace: {{ include "muster.namespace" . | quote }}
