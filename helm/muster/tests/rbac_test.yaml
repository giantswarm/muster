# RBAC template tests for muster Helm chart
#
# These tests verify the RBAC resources created by the Helm chart.
# Muster requires access to:
#   - Muster CRDs (MCPServer, ServiceClass, Workflow)
#   - CRD discovery
#   - Events (for core_events tool)
#   - Secrets (for reading credentials)
#
# Run with: helm unittest ./helm/muster

suite: RBAC template tests
templates:
  - templates/rbac.yaml
tests:
  # ==========================================
  # Basic RBAC Tests
  # ==========================================
  
  - it: should create ClusterRole and ClusterRoleBinding
    set:
      serviceAccount.create: true
      rbac.create: true
    asserts:
      - hasDocuments:
          count: 2
      - isKind:
          of: ClusterRole
        documentIndex: 0
      - isKind:
          of: ClusterRoleBinding
        documentIndex: 1

  - it: should not create any RBAC when serviceAccount.create is false
    set:
      serviceAccount.create: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should not create any RBAC when rbac.create is false
    set:
      serviceAccount.create: true
      rbac.create: false
    asserts:
      - hasDocuments:
          count: 0

  # ==========================================
  # Muster CRD Access Tests
  # ==========================================

  - it: should include muster CRD access
    set:
      serviceAccount.create: true
      rbac.create: true
    asserts:
      - contains:
          path: rules
          content:
            apiGroups: ["muster.giantswarm.io"]
            resources: ["mcpservers", "serviceclasses", "workflows"]
            verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
        documentIndex: 0

  - it: should include status subresource permissions for muster CRDs
    set:
      serviceAccount.create: true
      rbac.create: true
    asserts:
      - contains:
          path: rules
          content:
            apiGroups: ["muster.giantswarm.io"]
            resources: ["mcpservers/status", "serviceclasses/status", "workflows/status"]
            verbs: ["get", "update", "patch"]
        documentIndex: 0

  # ==========================================
  # CRD Discovery Tests
  # ==========================================

  - it: should include CRD discovery access
    set:
      serviceAccount.create: true
      rbac.create: true
    asserts:
      - contains:
          path: rules
          content:
            apiGroups: ["apiextensions.k8s.io"]
            resources: ["customresourcedefinitions"]
            verbs: ["get", "list", "watch"]
        documentIndex: 0

  # ==========================================
  # Events Access Tests
  # ==========================================

  - it: should include events access for core_events tool
    set:
      serviceAccount.create: true
      rbac.create: true
    asserts:
      - contains:
          path: rules
          content:
            apiGroups: [""]
            resources: ["events"]
            verbs: ["get", "list", "watch", "create"]
        documentIndex: 0

  # ==========================================
  # Secrets Access Tests
  # ==========================================

  - it: should include secrets read access for credentials
    set:
      serviceAccount.create: true
      rbac.create: true
    asserts:
      - contains:
          path: rules
          content:
            apiGroups: [""]
            resources: ["secrets"]
            verbs: ["get"]
        documentIndex: 0

  # ==========================================
  # ClusterRoleBinding Tests
  # ==========================================

  - it: should bind to correct service account
    set:
      serviceAccount.create: true
      rbac.create: true
    asserts:
      - equal:
          path: subjects[0].kind
          value: ServiceAccount
        documentIndex: 1
      - equal:
          path: subjects[0].name
          value: RELEASE-NAME-muster
        documentIndex: 1
