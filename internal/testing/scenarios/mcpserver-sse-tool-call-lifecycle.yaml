name: "mcpserver-sse-tool-call-lifecycle"
category: "behavioral"
concept: "mcpserver"
tags: ["mcpserver", "lifecycle", "tool-calls", "sse", "url-based", "core-api", "experimental"]
timeout: "5m"
# NOTE: SSE transport has session management complexity that may cause intermittent failures.
# The SSE protocol requires an active stream connection to maintain session state.
# This test is marked experimental until SSE session handling is more robust.
skip: true

# Test Story: SSE MCP Server Tool Call Behavior During Lifecycle
# Given: An MCP server with tools accessed via SSE transport
# When: The MCP server is running
# Then: Tool calls should work successfully
# When: I stop the MCP server
# Then: Tool calls should fail with "tool doesn't exist" error
# When: I start the MCP server again
# Then: Tool calls should work successfully again

pre_configuration:
  mcp_servers:
    - name: "sse-tool-provider"
      config:
        type: "sse"
        tools:
          - name: "sse_test_tool"
            description: "A tool that tests SSE-based MCP server connectivity"
            input_schema:
              type: "object"
              properties:
                action: { type: "string" }
                data: { type: "string" }
            responses:
              - response:
                  transport: "sse"
                  action: "{{ .action }}"
                  data: "{{ .data }}"
                  server: "sse-tool-provider"
                  status: "executed"

steps:
  # Phase 1: Verify tool calls work when MCP server is running
  - id: "verify-service-running-initially"
    description: "Verify the SSE MCP server service is running"
    tool: "core_service_status"
    args:
      name: "sse-tool-provider"
    expected:
      success: true
      json_path:
        name: "sse-tool-provider"
        state: "running"

  - id: "test-tool-call-when-running"
    description: "Test that tool calls work when SSE server is running"
    tool: "x_sse-tool-provider_sse_test_tool"
    args:
      action: "test"
      data: "initial-sse-call"
    expected:
      success: true
      contains: ["test", "initial-sse-call", "executed", "sse"]

  - id: "test-another-tool-call-when-running"
    description: "Test another tool call to verify consistency"
    tool: "x_sse-tool-provider_sse_test_tool"
    args:
      action: "verify"
      data: "sse-server-is-running"
    expected:
      success: true
      contains: ["verify", "sse-server-is-running", "executed"]

  # Phase 2: Stop the MCP server and verify tool calls fail
  - id: "stop-mcpserver-service"
    description: "Stop the SSE MCP server service"
    tool: "core_service_stop"
    args:
      name: "sse-tool-provider"
    expected:
      success: true

  - id: "wait-for-stopped-mcpserver-service"
    description: "Wait for the service to be fully stopped"
    tool: "core_service_status"
    args:
      name: "sse-tool-provider"
    expected:
      success: true
      wait_for_state: "30s"
      json_path:
        name: "sse-tool-provider"
        state: "stopped"

  - id: "test-tool-call-fails-when-stopped"
    description: "Verify tool calls fail when SSE server is stopped"
    tool: "x_sse-tool-provider_sse_test_tool"
    args:
      action: "should-fail"
      data: "sse-server-stopped"
    expected:
      success: false
      error_contains: ["tool not found"]

  # Phase 3: Start the MCP server and verify tool calls work again
  - id: "start-mcpserver-service"
    description: "Start the SSE MCP server service again"
    tool: "core_service_start"
    args:
      name: "sse-tool-provider"
    expected:
      success: true

  - id: "wait-for-started-mcpserver-service"
    description: "Wait for the service to be fully started"
    tool: "core_service_status"
    args:
      name: "sse-tool-provider"
    expected:
      success: true
      wait_for_state: "30s"
      json_path:
        name: "sse-tool-provider"
        state: "running"

  - id: "test-tool-call-works-after-restart"
    description: "Verify tool calls work after SSE server restart"
    tool: "x_sse-tool-provider_sse_test_tool"
    args:
      action: "restart-test"
      data: "sse-server-restarted"
    expected:
      success: true
      contains: ["restart-test", "sse-server-restarted", "executed"]

cleanup:
  - id: "cleanup-stop-service"
    description: "Stop the SSE MCP server during cleanup"
    tool: "core_service_stop"
    args:
      name: "sse-tool-provider"
    expected:
      success: true
    continue_on_failure: true

