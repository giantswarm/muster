name: "oauth-concurrent-code-exchange-multi-user"
category: "behavioral"
concept: "mcpserver"
description: |
  Test scenario for issue #269: Multi-server OAuth flow isolation.
  
  This scenario tests what happens when a user rapidly authenticates to
  multiple MCPServers that require fallback OAuth flows. The key test is
  whether OAuth flows for different servers can interfere with each other.
  
  Test conditions:
  1. Multiple MCPServers are configured with different auth strategies
  2. Some use token forwarding (works with muster's ID token)
  3. Some use different IdPs requiring fallback OAuth
  4. Multiple fallback flows are started in quick succession
  
  This test verifies:
  1. OAuth flows for multiple servers complete correctly
  2. Each server receives the correct token from its IdP
  3. No cross-contamination of tokens/auth state between servers

tags: ["oauth", "authentication", "security", "issue-269", "multi-server", "session-isolation", "mcpserver"]
timeout: "2m"

pre_configuration:
  mock_oauth_servers:
    # Muster's upstream Dex
    - name: "muster-dex"
      scopes: ["openid", "profile", "email", "groups", "mcp:admin"]
      auto_approve: true
      pkce_required: true
      token_lifetime: "1h"
      client_id: "muster-client"
      client_secret: "muster-secret"
      use_as_muster_oauth_server: true

    # IdP for server-alpha (different from muster's Dex)
    - name: "alpha-idp"
      scopes: ["openid", "profile", "email", "mcp:admin"]
      auto_approve: true
      pkce_required: true
      token_lifetime: "1h"
      client_id: "alpha-client"

    # IdP for server-beta (different from muster's Dex)
    - name: "beta-idp"
      scopes: ["openid", "profile", "email", "mcp:admin"]
      auto_approve: true
      pkce_required: true
      token_lifetime: "1h"
      client_id: "beta-client"

  mcp_servers:
    # Server using muster's Dex (token forwarding works)
    - name: "server-muster"
      config:
        type: "streamable-http"
        oauth:
          required: true
          mock_oauth_server_ref: "muster-dex"
          scope: "mcp:admin"
          forward_token: true
          fallback_to_own_auth: true
        tools:
          - name: "muster_op"
            description: "Operation on muster-dex server"
            responses:
              - response:
                  server: "server-muster"
                  idp: "muster-dex"

    # Server requiring fallback to alpha-idp
    - name: "server-alpha"
      config:
        type: "streamable-http"
        oauth:
          required: true
          mock_oauth_server_ref: "alpha-idp"
          scope: "mcp:admin"
          forward_token: true
          fallback_to_own_auth: true
        tools:
          - name: "alpha_op"
            description: "Operation on alpha server"
            responses:
              - response:
                  server: "server-alpha"
                  idp: "alpha-idp"

    # Server requiring fallback to beta-idp
    - name: "server-beta"
      config:
        type: "streamable-http"
        oauth:
          required: true
          mock_oauth_server_ref: "beta-idp"
          scope: "mcp:admin"
          forward_token: true
          fallback_to_own_auth: true
        tools:
          - name: "beta_op"
            description: "Operation on beta server"
            responses:
              - response:
                  server: "server-beta"
                  idp: "beta-idp"

steps:
  # Verify OAuth servers
  - id: verify-muster-dex
    description: "Verify muster-dex is running"
    tool: "test_get_oauth_server_info"
    args:
      server: "muster-dex"
    expected:
      success: true
      contains:
        - "muster-dex"

  - id: verify-alpha-idp
    description: "Verify alpha-idp is running"
    tool: "test_get_oauth_server_info"
    args:
      server: "alpha-idp"
    expected:
      success: true
      contains:
        - "alpha-idp"

  - id: verify-beta-idp
    description: "Verify beta-idp is running"
    tool: "test_get_oauth_server_info"
    args:
      server: "beta-idp"
    expected:
      success: true
      contains:
        - "beta-idp"

  # Verify servers are registered
  - id: verify-servers
    description: "Verify all servers are registered"
    tool: "core_mcpserver_list"
    args: {}
    expected:
      success: true
      contains:
        - "server-muster"
        - "server-alpha"
        - "server-beta"

  # Step 1: Authenticate to server-muster (establishes ID token)
  - id: auth-muster
    description: "Authenticate to server-muster via muster-dex"
    tool: "test_simulate_oauth_callback"
    args:
      server: "server-muster"
    expected:
      success: true

  - id: connect-muster
    description: "Connect to server-muster (token forwarding)"
    tool: "core_auth_login"
    args:
      server: "server-muster"
    expected:
      success: true

  # Step 2: Start OAuth flow for server-alpha (triggers fallback)
  - id: trigger-alpha-fallback
    description: "Trigger fallback OAuth for server-alpha"
    tool: "core_auth_login"
    args:
      server: "server-alpha"
    expected:
      success: true

  # Step 3: Start OAuth flow for server-beta (triggers fallback)
  # At this point, there are TWO pending OAuth flows
  - id: trigger-beta-fallback
    description: "Trigger fallback OAuth for server-beta"
    tool: "core_auth_login"
    args:
      server: "server-beta"
    expected:
      success: true

  # Step 4: Complete OAuth for server-alpha
  - id: complete-alpha-auth
    description: "Complete OAuth callback for server-alpha"
    tool: "test_simulate_oauth_callback"
    args:
      server: "server-alpha"
    expected:
      success: true
      contains:
        - "success"

  # Step 5: Complete OAuth for server-beta
  - id: complete-beta-auth
    description: "Complete OAuth callback for server-beta"
    tool: "test_simulate_oauth_callback"
    args:
      server: "server-beta"
    expected:
      success: true
      contains:
        - "success"

  # Step 6: Login to both servers after auth
  - id: login-alpha
    description: "Login to server-alpha after OAuth"
    tool: "core_auth_login"
    args:
      server: "server-alpha"
    expected:
      success: true

  - id: login-beta
    description: "Login to server-beta after OAuth"
    tool: "core_auth_login"
    args:
      server: "server-beta"
    expected:
      success: true

  # Step 7: Verify each server responds with correct identity
  - id: call-muster-op
    description: "Call tool on server-muster"
    tool: "x_server-muster_muster_op"
    args: {}
    expected:
      success: true
      contains:
        - "server-muster"
        - "muster-dex"

  - id: call-alpha-op
    description: "Call tool on server-alpha"
    tool: "x_server-alpha_alpha_op"
    args: {}
    expected:
      success: true
      contains:
        - "server-alpha"
        - "alpha-idp"

  - id: call-beta-op
    description: "Call tool on server-beta"
    tool: "x_server-beta_beta_op"
    args: {}
    expected:
      success: true
      contains:
        - "server-beta"
        - "beta-idp"

  # Step 8: Verify auth status shows all servers connected
  - id: verify-auth-status
    description: "Verify all servers are connected with correct status"
    tool: "test_read_auth_status"
    args: {}
    expected:
      success: true
      contains:
        - "server-muster"
        - "server-alpha"
        - "server-beta"
        - "connected"
