name: "oauth-token-expiry-handling"
category: "behavioral"
concept: "mcpserver"
description: "Verify token expiry detection using mock clock advancement"
tags: ["oauth", "token-expiry", "mock-clock", "adr-008"]
timeout: "2m"

pre_configuration:
  mock_oauth_servers:
    - name: "expiry-idp"
      scopes: ["openid", "profile"]
      auto_approve: true
      pkce_required: false
      # Short token lifetime for expiry testing
      token_lifetime: "30m"
      client_id: "expiry-client"
      # Enable mock clock so we can advance time without waiting
      use_mock_clock: true

  mcp_servers:
    - name: "expiry-server"
      config:
        type: "streamable-http"
        oauth:
          required: true
          mock_oauth_server_ref: "expiry-idp"
        tools:
          - name: "time_sensitive_op"
            description: "An operation that requires a valid (non-expired) token"
            responses:
              - response:
                  status: "ok"
                  data: "operation completed"

steps:
  # Step 1: Verify mock clock OAuth server is running
  - id: verify-oauth-server
    description: "Verify the OAuth server with mock clock is running"
    tool: "test_get_oauth_server_info"
    args:
      server: "expiry-idp"
    expected:
      success: true
      contains:
        - "expiry-idp"
        - "issuer_url"

  # Step 2: Authenticate
  - id: authenticate
    description: "Complete OAuth flow"
    tool: "test_simulate_oauth_callback"
    args:
      server: "expiry-server"
    expected:
      success: true
      contains:
        - "success"

  # Step 3: Establish connection
  - id: establish-connection
    description: "Establish session connection"
    tool: "x_expiry-server_authenticate"
    args: {}
    expected:
      success: true

  # Step 4: Verify tool works initially
  - id: call-tool-before-expiry
    description: "Protected tool should work with valid token"
    tool: "x_expiry-server_time_sensitive_op"
    args: {}
    expected:
      success: true
      contains:
        - "status"
        - "ok"

  # Step 5: Advance clock past token expiry (token lifetime is 30m)
  - id: advance-clock
    description: "Advance OAuth server clock past token expiry"
    tool: "test_advance_oauth_clock"
    args:
      server: "expiry-idp"
      duration: "1h"
    expected:
      success: true
      contains:
        - "Advanced OAuth clock"

  # Step 6: Try to use the tool again - token should be expired
  # The OAuth server will reject the token as expired
  # Note: This tests that the mock OAuth server correctly rejects expired tokens
  # The actual behavior depends on how the aggregator handles 401 responses
  - id: verify-server-still-accessible
    description: "Server should still be listed even with expired token"
    tool: "core_mcpserver_get"
    args:
      name: "expiry-server"
    expected:
      success: true
      contains:
        - "expiry-server"
