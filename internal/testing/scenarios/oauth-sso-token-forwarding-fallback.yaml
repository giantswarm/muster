name: "oauth-sso-token-forwarding-fallback"
category: "behavioral"
concept: "mcpserver"
description: "Test fallback to separate OAuth flow when SSO token forwarding fails"
tags: ["oauth", "sso", "token-forwarding", "fallback", "authentication", "mcpserver"]
timeout: "2m"

pre_configuration:
  # Two different OAuth servers - muster uses one, downstream uses another
  mock_oauth_servers:
    - name: "muster-idp"
      scopes: ["openid", "profile"]
      auto_approve: true
      pkce_required: false
      token_lifetime: "1h"
      client_id: "muster-client"

    - name: "downstream-idp"
      scopes: ["openid", "profile", "mcp:admin"]
      auto_approve: true
      pkce_required: false
      token_lifetime: "1h"
      client_id: "downstream-client"

  # MCP server configured for SSO token forwarding with fallback enabled
  # This server does NOT trust muster's ID tokens (different IDP)
  # So it should fallback to its own auth flow
  mcp_servers:
    - name: "fallback-server"
      config:
        type: "streamable-http"
        oauth:
          required: true
          mock_oauth_server_ref: "downstream-idp"
          scope: "mcp:admin"
          # Token forwarding is enabled but will fail because different IDP
          forward_token: true
          # Fallback to separate auth flow when forwarding fails
          fallback_to_own_auth: true
        tools:
          - name: "fallback_op"
            description: "Operation on server with fallback"
            responses:
              - response:
                  source: "fallback-server"
                  status: "authenticated-via-fallback"

steps:
  # Step 1: Verify the mock OAuth servers are running
  - id: verify-muster-oauth
    description: "Verify the muster OAuth server is running"
    tool: "test_get_oauth_server_info"
    args:
      server: "muster-idp"
    expected:
      success: true
      contains:
        - "muster-idp"

  - id: verify-downstream-oauth
    description: "Verify the downstream OAuth server is running"
    tool: "test_get_oauth_server_info"
    args:
      server: "downstream-idp"
    expected:
      success: true
      contains:
        - "downstream-idp"

  # Step 2: Verify the MCP server is registered
  - id: verify-server-registered
    description: "Verify the fallback server is registered"
    tool: "core_mcpserver_list"
    args: {}
    expected:
      success: true
      contains:
        - "fallback-server"

  # Step 3: Authenticate to muster (get ID token from muster-idp)
  # But this token won't work for the downstream server which uses downstream-idp
  - id: authenticate-muster
    description: "Authenticate to muster via OAuth (get muster ID token)"
    tool: "test_simulate_oauth_callback"
    args:
      server: "fallback-server"
    expected:
      success: true
      contains:
        - "success"

  # Step 4: Call core_auth_login - token forwarding should fail, fallback should trigger
  # Since fallback_to_own_auth is true, it should proceed with separate OAuth flow
  - id: login-with-fallback
    description: "Login to server - token forwarding should fail, fallback to separate auth"
    tool: "core_auth_login"
    args:
      server: "fallback-server"
    expected:
      success: true

  # Step 5: Verify the server tools are available after fallback authentication
  - id: call-fallback-tool
    description: "Call tool on server authenticated via fallback OAuth flow"
    tool: "x_fallback-server_fallback_op"
    args: {}
    expected:
      success: true
      contains:
        - "fallback-server"
