name: "oauth-protected-mcp-server"
category: "behavioral"
concept: "mcpserver"
description: "Test OAuth-protected MCP server with simulated authentication flow"
tags: ["oauth", "authentication", "mcpserver"]
timeout: "2m"

pre_configuration:
  # Start a mock OAuth server
  mock_oauth_servers:
    - name: "mock-idp"
      scopes: ["openid", "profile", "mcp:read"]
      auto_approve: true
      pkce_required: false
      token_lifetime: "1h"
      client_id: "test-client"

  # OAuth-protected MCP server
  mcp_servers:
    - name: "protected-server"
      config:
        type: "streamable-http"
        oauth:
          required: true
          mock_oauth_server_ref: "mock-idp"
          scope: "mcp:read"
        tools:
          - name: "get_secret"
            description: "Returns a secret value that requires authentication"
            responses:
              - response:
                  secret: "super-secret-value"
                  message: "You are authenticated!"

steps:
  - id: list-servers
    description: "List MCP servers to verify protected server is configured"
    tool: "core_mcpserver_list"
    args: {}
    expected:
      success: true
      contains:
        - "protected-server"

  - id: verify-server-exists
    description: "Verify the protected server is registered"
    tool: "core_mcpserver_get"
    args:
      name: "protected-server"
    expected:
      success: true
      contains:
        - "protected-server"

  - id: get-oauth-server-info
    description: "Get information about the mock OAuth server"
    tool: "test_get_oauth_server_info"
    args: {}
    expected:
      success: true
      contains:
        - "mock-idp"

  - id: simulate-auth-callback
    description: "Simulate OAuth callback to complete authentication"
    tool: "test_simulate_oauth_callback"
    args:
      server: "protected-server"
    expected:
      success: true
      contains:
        - "success"
